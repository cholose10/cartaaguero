<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Carta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f3f0; color:#333; }
    h1 { margin-bottom: 15px; }
    .toolbar { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
    input, textarea { width: 100%; padding: 6px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 6px 12px; background:#8c6954; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button:hover{ background:#6b4e3d; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th{ background:#eee; }
    td img { max-width:60px; border-radius:6px; }
    .preview { margin-top: 20px; padding:10px; background:#fff; border:1px solid #ddd; border-radius:10px; }
    .preview img{ width:100%; height:180px; object-fit:cover; }
  </style>
</head>
<body>

<h1>Admin Carta</h1>

<div class="toolbar">
  <label>Token GitHub:</label>
  <input type="password" id="tokenInput" placeholder="PegÃ¡ tu token">
  <button onclick="exportExcel()">ðŸ“¤ Exportar Excel</button>
  <input type="file" id="importFile" accept=".xlsx" style="display:none" onchange="importExcel(event)">
  <label for="importFile"><button type="button">ðŸ“¥ Importar Excel</button></label>
  <input type="text" id="searchBox" placeholder="ðŸ”Ž Buscar producto o categorÃ­a" oninput="renderTable()">
  <button onclick="resetSearch()">Reset</button>
</div>

<form id="productForm">
  <input type="hidden" id="editIndex">
  <label>Nombre:</label>
  <input type="text" id="nombre" required>
  <label>DescripciÃ³n:</label>
  <textarea id="descripcion" required></textarea>
  <label>Precio:</label>
  <input type="text" id="precio" required>
  <label>Imagen (ej: cafe.jpg):</label>
  <input type="text" id="imagen" required>
  <label>CategorÃ­a:</label>
  <input type="text" id="categoria" required>
  <button type="submit">Guardar</button>
</form>

<div class="preview">
  <h3>Vista previa</h3>
  <img id="prevImg" src="">
  <p><b id="prevNombre">â€”</b></p>
  <p id="prevDescripcion">â€”</p>
  <p><span id="prevCategoria">â€”</span> | <span id="prevPrecio">â€”</span></p>
</div>

<h2>Productos actuales</h2>
<table>
  <thead>
    <tr>
      <th>Imagen</th><th>Nombre</th><th>DescripciÃ³n</th><th>CategorÃ­a</th><th>Precio</th><th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const USERNAME = "cholose10"; 
const REPO = "Carta"; 
const FILE_PATH = "productos.json"; 
const BRANCH = "main"; 
let productos = [];

// cargar productos
async function loadProducts(){
  const res = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${FILE_PATH}`);
  productos = await res.json();
  renderTable();
}
loadProducts();

// vista previa
function updatePreview(){
  document.getElementById("prevNombre").textContent = nombre.value || "â€”";
  document.getElementById("prevDescripcion").textContent = descripcion.value || "â€”";
  document.getElementById("prevCategoria").textContent = categoria.value || "â€”";
  document.getElementById("prevPrecio").textContent = precio.value ? "$"+precio.value : "â€”";
  document.getElementById("prevImg").src = imagen.value ? "img/"+imagen.value : "";
}
["nombre","descripcion","precio","imagen","categoria"].forEach(id=>{
  document.getElementById(id).addEventListener("input",updatePreview);
});

// render tabla
function renderTable(){
  const search = searchBox.value.toLowerCase();
  const body = document.getElementById("tableBody");
  body.innerHTML="";
  productos.map((p,i)=>({p,i}))
    .filter(({p})=>(p.nombre||"").toLowerCase().includes(search)||(p.categoria||"").toLowerCase().includes(search))
    .forEach(({p,i})=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><img src="${p.imagen}"></td>
        <td>${p.nombre}</td>
        <td>${p.descripcion}</td>
        <td>${p.categoria}</td>
        <td>${p.precio}</td>
        <td>
          <button onclick="editProduct(${i})">Editar</button>
          <button onclick="deleteProduct(${i})">Eliminar</button>
        </td>`;
      body.appendChild(tr);
    });
}

function resetSearch(){ searchBox.value=""; renderTable(); }

// guardar producto
productForm.onsubmit = async e=>{
  e.preventDefault();
  const index = editIndex.value;
  const nuevo = {
    nombre:nombre.value, descripcion:descripcion.value, precio:precio.value,
    imagen:"img/"+imagen.value, categoria:categoria.value
  };
  if(index===""){ productos.push(nuevo); } else { productos[index]=nuevo; editIndex.value=""; }
  await saveToGitHub(); renderTable(); productForm.reset(); updatePreview();
}

// editar
function editProduct(i){
  const p=productos[i];
  nombre.value=p.nombre; descripcion.value=p.descripcion; precio.value=p.precio;
  imagen.value=p.imagen.replace("img/",""); categoria.value=p.categoria;
  editIndex.value=i; updatePreview(); window.scrollTo({top:0,behavior:"smooth"});
}

// eliminar
async function deleteProduct(i){
  if(confirm("Â¿Eliminar este producto?")){ productos.splice(i,1); await saveToGitHub(); renderTable(); }
}

// guardar en GitHub
async function saveToGitHub(){
  const TOKEN=tokenInput.value.trim(); if(!TOKEN){alert("PegÃ¡ tu token");return;}
  let sha; try{const r=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`);if(r.ok){sha=(await r.json()).sha;}}catch{}
  const content=btoa(unescape(encodeURIComponent(JSON.stringify(productos,null,2))));
  const r=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`,{
    method:"PUT",
    headers:{Authorization:`token ${TOKEN}`,"Content-Type":"application/json"},
    body:JSON.stringify({message:"update productos",content,sha,branch:BRANCH})
  });
  if(!r.ok){alert("Error guardando en GitHub");}
}

// export excel
function exportExcel(){
  const data=productos.map(p=>({"Nombre":p.nombre,"DescripciÃ³n":p.descripcion,"CategorÃ­a":p.categoria,"Precio":p.precio}));
  const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Productos");
  XLSX.writeFile(wb,"productos.xlsx");
}

// importar excel
async function importExcel(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    const data=new Uint8Array(ev.target.result); const wb=XLSX.read(data,{type:"array"});
    const sheet=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(sheet);
    productos=rows.map(r=>({nombre:r.Nombre||"",descripcion:r.DescripciÃ³n||"",categoria:r.CategorÃ­a||"",precio:r.Precio||"",imagen:"img/default.jpg"}));
    await saveToGitHub(); renderTable();
  };
  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
