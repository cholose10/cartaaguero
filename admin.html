<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Carta - Don Pilose</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f3f0; color: #333; }
    h1 { text-align: center; color: #806250; }
    form { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; transition: box-shadow 0.5s; }
    form.editando { box-shadow: 0 0 15px #806250; }
    input, textarea, datalist { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ccc; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #806250; color: white; }
    img { max-width: 60px; border-radius: 6px; }
    button { cursor: pointer; background: #806250; color: white; border: none; padding: 6px 10px; border-radius: 6px; transition: background 0.3s; }
    button:hover { background: #a07b68; }
    #preview { max-width: 100px; margin-top: 5px; display: block; border-radius: 8px; }
    #search { width: 60%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .search-container { display: flex; gap: 10px; margin-bottom: 15px; }
    #btnArriba { position: fixed; bottom: 25px; right: 25px; background: #806250; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; z-index: 100; transition: background 0.3s; }
    #btnArriba:hover { background: #a07b68; }
  </style>
</head>
<body>
  <h1>Panel de Administración - Don Pilose</h1>

  <!-- TOKEN -->
  <div style="margin-bottom:15px; background:#eee; padding:10px; border-radius:8px;">
    <label for="token">Token de GitHub:</label><br>
    <input type="password" id="token" placeholder="Pega tu token aquí" style="width:70%; padding:8px;">
    <button onclick="saveToken()">Guardar Token</button>
    <button onclick="clearToken()">Borrar Token</button>
    <p id="tokenStatus"></p>
  </div>

  <!-- BUSCADOR -->
  <div class="search-container">
    <input type="text" id="search" placeholder="Buscar producto...">
    <button onclick="filterProducts(true)">Buscar</button>
  </div>

  <!-- FORMULARIO -->
  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label>
    <input type="text" id="nombre" required>

    <label>Descripción</label>
    <textarea id="descripcion" required></textarea>

    <label>Precio</label>
    <input type="number" id="precio" required>

    <label>Imagen (ej: img/foto.jpg)</label>
    <input type="text" id="imagen" required oninput="previewImage()">
    <img id="preview" src="" alt="Vista previa">

    <label>Categoría</label>
    <input list="listaCategorias" type="text" id="categoria" placeholder="Ej: CAFETERÍA, POSTRES, etc." required>
    <datalist id="listaCategorias"></datalist>

    <button type="submit">Guardar</button>
  </form>

  <!-- TABLA -->
  <h2 id="tablaTitulo">Productos</h2>
  <table>
    <thead>
      <tr>
        <th>Imagen</th><th>Nombre</th><th>Descripción</th><th>Categoría</th><th>Precio</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- BOTÓN ARRIBA -->
  <button id="btnArriba" onclick="subir()">⬆</button>

  <script>
    // CONFIG GITHUB
    const USERNAME = "donpilose-wq";
    const REPO = "menuclick";
    const FILE_PATH = "productos.json";
    let productos = [];

    // TOKEN
    function saveToken(){
      const t=document.getElementById('token').value.trim();
      if(t){
        localStorage.setItem('github_token',t);
        document.getElementById('token').value='';
        document.getElementById('tokenStatus').innerText="✅ Token guardado.";
      }
    }
    function clearToken(){
      localStorage.removeItem('github_token');
      document.getElementById('tokenStatus').innerText="⚠ Token borrado.";
    }
    function getToken(){ return localStorage.getItem('github_token'); }

    // CARGAR PRODUCTOS
    async function loadProducts(){
      try {
        const res = await fetch("productos.json");
        if (!res.ok) throw new Error("No se pudo cargar productos.json");
        productos = await res.json();
        render(productos); // render con índices originales
        updateCategoryList();
      } catch (err) {
        console.error("Error al cargar productos:", err);
        alert("⚠ No se pudieron cargar los productos.");
      }
    }

    // RENDER TABLA (mantiene índices originales para Editar/Borrar)
    function render(lista, originalIndices=null){
      const tb=document.getElementById('tbody'); tb.innerHTML='';
      lista.forEach((p,i)=>{
        const idx = originalIndices ? originalIndices[i] : i;
        tb.innerHTML+=`
          <tr data-index="${idx}">
            <td><img src="${p.imagen}" alt=""></td>
            <td>${p.nombre}</td>
            <td>${p.descripcion}</td>
            <td>${p.categoria}</td>
            <td>$${p.precio}</td>
            <td>
              <button onclick="edit(${idx})">Editar</button>
              <button onclick="del(${idx})">Eliminar</button>
            </td>
          </tr>`;
      });
    }

    // ACTUALIZAR CATEGORÍAS
    function updateCategoryList(){
      const cats=[...new Set(productos.map(p=>p.categoria))].sort();
      const datalist=document.getElementById('listaCategorias');
      datalist.innerHTML='';
      cats.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c;
        datalist.appendChild(opt);
      });
    }

    // BUSCADOR MEJORADO
    const searchInput = document.getElementById("search");
    // busca al tipear (coincidencia parcial por letra)
    searchInput.addEventListener("input", ()=> filterProducts(false));
    // al presionar Enter busca y baja al primer resultado
    searchInput.addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        filterProducts(true);
      }
    });

    /**
     * filterProducts(scrollToFirst)
     * - scrollToFirst: si es true, baja al primer producto encontrado.
     */
    function filterProducts(scrollToFirst = false){
      const q = (searchInput.value || '').toLowerCase().trim();
      if(q === ''){
        // campo vacío → mostrar todo y subir al título
        render(productos);
        updateCategoryList();
        if(scrollToFirst) document.getElementById("tablaTitulo").scrollIntoView({ behavior: "smooth" });
        return;
      }

      // buscamos índices originales para que Edit/Del funcionen correctamente
      const indices = [];
      productos.forEach((p, i) => {
        const nombre = (p.nombre||'').toLowerCase();
        const desc = (p.descripcion||'').toLowerCase();
        const cat  = (p.categoria||'').toLowerCase();
        if(nombre.includes(q) || desc.includes(q) || cat.includes(q)){
          indices.push(i);
        }
      });

      const filtrados = indices.map(i => productos[i]);
      render(filtrados, indices);

      if(indices.length > 0 && scrollToFirst){
        // bajar al primer resultado
        const tbody = document.getElementById('tbody');
        const firstRow = tbody.querySelector('tr');
        if(firstRow){
          firstRow.scrollIntoView({ behavior: "smooth", block: "center" });
          // pequeño highlight para que se note
          const prevBg = firstRow.style.background;
          firstRow.style.background = "#fff4dc";
          setTimeout(()=> firstRow.style.background = prevBg, 1100);
        }
      }
      // si no encontró nada, dejamos la tabla vacía (o podés mostrar mensaje)
      if(indices.length === 0){
        // opcional: mostrar mensaje (descomentar si querés)
        // alert('No se encontraron productos con esa búsqueda.');
      }
    }

    // PREVIEW IMG
    function previewImage(){
      const src=document.getElementById('imagen').value.trim();
      document.getElementById('preview').src=src || '';
    }

    // GUARDAR EN GITHUB (corregido para evitar errores de sintaxis)
    async function saveToGitHub(newContent){
      const TOKEN=getToken();
      if(!TOKEN){ alert("⚠ Guardá tu token primero."); return; }

      const apiUrl = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;
      const getRes = await fetch(apiUrl, { headers: { Authorization: `token ${TOKEN}` } });
      const data = await getRes.json();
      const sha = data.sha;

      const updateRes = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          "Authorization": `token ${TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Actualización desde admin.html",
          content: btoa(unescape(encodeURIComponent(newContent))),
          sha: sha
        })
      });

      if(updateRes.ok){ alert("✅ Cambios guardados en GitHub."); }
      else{ 
        console.error('GitHub save error', await updateRes.text());
        alert("❌ Error al guardar en GitHub.");
      }
    }

    // GUARDAR PRODUCTO
    document.getElementById('form').onsubmit=function(e){
      e.preventDefault();
      const idx=document.getElementById('editIndex').value;
      const prod={
        nombre:document.getElementById('nombre').value,
        descripcion:document.getElementById('descripcion').value,
        precio:parseFloat(document.getElementById('precio').value),
        imagen:document.getElementById('imagen').value,
        categoria:document.getElementById('categoria').value
      };
      if(idx===''){ productos.push(prod);} 
      else { productos[idx]=prod; document.getElementById('editIndex').value=''; }
      render(productos);
      updateCategoryList();
      this.reset();
      document.getElementById('preview').src='';
      document.getElementById('form').classList.remove('editando');
      saveToGitHub(JSON.stringify(productos,null,2));
    }

    // EDITAR
    function edit(i){
      const p=productos[i];
      document.getElementById('nombre').value=p.nombre;
      document.getElementById('descripcion').value=p.descripcion;
      document.getElementById('precio').value=p.precio;
      document.getElementById('imagen').value=p.imagen;
      document.getElementById('categoria').value=p.categoria;
      document.getElementById('editIndex').value=i;
      document.getElementById('preview').src=p.imagen;

      const form=document.getElementById('form');
      form.scrollIntoView({ behavior: "smooth", block: "start" });
      form.classList.add('editando');
      setTimeout(()=>form.classList.remove('editando'), 2000);
    }

    // ELIMINAR
    function del(i){
      if(confirm('¿Eliminar producto?')){
        productos.splice(i,1);
        render(productos);
        updateCategoryList();
        saveToGitHub(JSON.stringify(productos,null,2));
      }
    }

    // BOTÓN SUBIR
    window.onscroll = function() {
      document.getElementById("btnArriba").style.display =
        window.scrollY > 300 ? "block" : "none";
    };
    function subir(){
      document.getElementById("form").scrollIntoView({ behavior: "smooth" });
    }

    // INICIO
    loadProducts();
    if(getToken()){ document.getElementById('tokenStatus').innerText="🔐 Token cargado."; }
  </script>
</body>
</html>
